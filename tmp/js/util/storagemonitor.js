define(["util/traverse","util/storage","util/arrays"],function(e,t,n){function o(e,t){if(typeof e!=typeof t)return!1;if(e instanceof Array){if(e.length!=t.length)return!1;for(var n=0;n<e.length;n++)if(!o(e[n],t[n]))return!1;return!0}if(e instanceof Object){var r=$.map(e,function(e,t){return t}),i=$.map(t,function(e,t){return t});if(!o(r,i))return!1;for(var n=0;n<r.length;n++)if(!o(e[r[n]],t[r[n]]))return!1;return!0}return e===t}function u(){var t=!1;for(var n=0;n<r.length;n++){s=r[n];if(s.monitor.paths.length==0||s.dirty())return;t||($.jStorage.reInit(),t=!0);var i=s.all(),u=s.monitor.paths.length,a=$.jStorage.get(s.monitor.key,{}),f,l;for(var c=0;c<u;c++){f=s.monitor.paths[c],l=e.get(a,f);if("undefined"==typeof s.monitor.last[f]){s.monitor.last[f]=l;continue}if(o(s.monitor.last[f],l))continue;if(o(l,e.get(i,f)))continue;s.monitor.last[f]=l,e.set(i,f,l),$(s).trigger(f,[l])}}}function a(e){return r.indexOf(e)>=0}function f(e){n.remove(r,e).push(e),r.length===1&&setInterval(u,5e3)}function l(e){n.remove(r,e),r.length===0&&clearInterval(i)}var r=[],i,s;return function(e,n){var r=t(e,n),i;return r.monitor=i=function(){var t={};return{paths:[],last:{},key:e,start:function(e){f(r)},end:function(){l()},monitoring:function(){return a(r)},bind:function(e,n){t[e]=t[e]&&++t[e]||1,t[e]===1&&r.monitor.paths.push(e),$(r).on(e,n)},unbind:function(e,n){if(!t[e])return;t[e]--,t[e]===0&&r.monitor.paths.splice(r.monitor.paths.indexOf(e),1),$(r).off(e,n)}}}(),i.start(),r}})